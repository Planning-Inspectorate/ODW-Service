{
	"name": "py_process_raw_to_standardised_delta_table",
	"properties": {
		"nbformat": 4,
		"nbformat_minor": 2,
		"bigDataPool": {
			"referenceName": "pinsodwspark",
			"type": "BigDataPoolReference"
		},
		"sessionProperties": {
			"driverMemory": "28g",
			"driverCores": 4,
			"executorMemory": "28g",
			"executorCores": 4,
			"numExecutors": 2,
			"conf": {
				"spark.dynamicAllocation.enabled": "false",
				"spark.dynamicAllocation.minExecutors": "2",
				"spark.dynamicAllocation.maxExecutors": "2",
				"spark.autotune.trackingId": "d763b7bc-468e-4eb4-9b08-58405ce52ba3"
			}
		},
		"metadata": {
			"saveOutput": true,
			"synapse_widget": {
				"version": "0.1",
				"state": {
					"5e71b628-c845-461c-9a4d-dcda95b96947": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "1",
										"1": "2022-02-24 15:41:47.719",
										"4": "MERGE",
										"5": {
											"predicate": "(existing.`Pers_no` = updates.`Pers_no`)",
											"matchedPredicates": "[{\"actionType\":\"update\"}]",
											"notMatchedPredicates": "[{\"actionType\":\"insert\"}]"
										},
										"9": "0",
										"11": "false",
										"12": {
											"numTargetRowsCopied": "0",
											"numTargetRowsDeleted": "0",
											"numTargetFilesAdded": "200",
											"executionTimeMs": "14647",
											"numTargetRowsInserted": "0",
											"scanTimeMs": "2511",
											"numTargetRowsUpdated": "922",
											"numOutputRows": "922",
											"numSourceRows": "922",
											"numTargetFilesRemoved": "1",
											"rewriteTimeMs": "12104"
										}
									},
									{
										"0": "0",
										"1": "2022-02-24 15:39:38.462",
										"4": "WRITE",
										"5": {
											"mode": "ErrorIfExists",
											"partitionBy": "[]"
										},
										"11": "true",
										"12": {
											"numFiles": "1",
											"numOutputBytes": "95643",
											"numOutputRows": "922"
										}
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "version",
										"type": "bigint"
									},
									{
										"key": "1",
										"name": "timestamp",
										"type": "timestamp"
									},
									{
										"key": "2",
										"name": "userId",
										"type": "string"
									},
									{
										"key": "3",
										"name": "userName",
										"type": "string"
									},
									{
										"key": "4",
										"name": "operation",
										"type": "string"
									},
									{
										"key": "5",
										"name": "operationParameters",
										"type": "MapType(StringType,StringType,true)"
									},
									{
										"key": "6",
										"name": "job",
										"type": "StructType(StructField(jobId,StringType,true), StructField(jobName,StringType,true), StructField(runId,StringType,true), StructField(jobOwnerId,StringType,true), StructField(triggerType,StringType,true))"
									},
									{
										"key": "7",
										"name": "notebook",
										"type": "StructType(StructField(notebookId,StringType,true))"
									},
									{
										"key": "8",
										"name": "clusterId",
										"type": "string"
									},
									{
										"key": "9",
										"name": "readVersion",
										"type": "bigint"
									},
									{
										"key": "10",
										"name": "isolationLevel",
										"type": "string"
									},
									{
										"key": "11",
										"name": "isBlindAppend",
										"type": "boolean"
									},
									{
										"key": "12",
										"name": "operationMetrics",
										"type": "MapType(StringType,StringType,true)"
									},
									{
										"key": "13",
										"name": "userMetadata",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "sum",
									"categoryFieldKeys": [
										"1"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					},
					"e2402cbb-f338-4d52-874e-bbd139be07f1": {
						"type": "Synapse.DataFrame",
						"sync_state": {
							"table": {
								"rows": [
									{
										"0": "00500001",
										"1": "Zelah",
										"2": "Vincent",
										"3": "08148620",
										"4": "1900",
										"5": "PINS",
										"6": "P200",
										"7": "Corporate Services",
										"8": "P215",
										"9": "Human Resources",
										"10": "60004069",
										"11": "Learning & Development",
										"12": "P2000000090530",
										"14": "PE",
										"15": "Permanent",
										"16": "01",
										"17": "Permanent Contract",
										"18": "AA",
										"19": "Administrative Assistant",
										"20": "81.079999999999998",
										"21": "30",
										"22": "Yes",
										"23": "3",
										"24": "Active",
										"25": "Female",
										"26": "00/00/0000",
										"27": "00/00/0000",
										"30": "814862",
										"31": "06",
										"32": "Restructure",
										"33": "70012439",
										"34": "HR Admin Assistant",
										"35": "90530",
										"36": "Human Resources",
										"37": "2005-12-12 00:00:00.0000000",
										"38": "4/1/2020",
										"39": "00/00/0000",
										"40": "2009-03-30 00:00:00.0000000",
										"41": "00500586",
										"42": "David Cobbin",
										"43": "70012435",
										"44": "Learning & Development Manager",
										"45": "Simon Levi",
										"46": "001",
										"47": "Bristol",
										"48": "2005-12-12 00:00:00.0000000",
										"49": "00/00/0000",
										"50": "00/00/0000",
										"51": "00/00/0000",
										"52": "1",
										"53": "Employee",
										"54": "xxxx",
										"55": "GBP",
										"57": "11/23/1979",
										"74": "PI",
										"75": "PINS",
										"77": "0.81081081081081086",
										"78": "2022-01-31 00:00:00.0000000",
										"79": "2022-02-01 14:30:26.0000000"
									},
									{
										"0": "00500002",
										"1": "Zoe",
										"2": "Hill",
										"3": "01492482",
										"4": "1900",
										"5": "PINS",
										"6": "P500",
										"7": "Operations",
										"8": "P510",
										"9": "Ops Group 2",
										"10": "60004134",
										"11": "Inquiries & Specialist Group 2",
										"12": "P5000000090220",
										"14": "PE",
										"15": "Permanent",
										"16": "01",
										"17": "Permanent Contract",
										"18": "BAND 3",
										"19": "Band 3 Inspector",
										"20": "85",
										"21": "37",
										"22": "Yes",
										"23": "3",
										"24": "Active",
										"25": "Female",
										"26": "00/00/0000",
										"27": "00/00/0000",
										"30": "149248",
										"31": "01",
										"32": "Change to Hours",
										"33": "70012702",
										"34": "Inspector Manager",
										"35": "90220",
										"36": "Inspectr Costs",
										"37": "2000-11-20 00:00:00.0000000",
										"39": "00/00/0000",
										"40": "2016-11-01 00:00:00.0000000",
										"41": "00500470",
										"42": "Kay Sully",
										"43": "70012533",
										"44": "Operations Lead",
										"45": "Simone Wilding",
										"46": "003",
										"47": "Home",
										"48": "2000-11-20 00:00:00.0000000",
										"49": "00/00/0000",
										"50": "00/00/0000",
										"51": "00/00/0000",
										"52": "1",
										"53": "Employee",
										"54": "xxxx",
										"55": "GBP",
										"57": "12/18/1967",
										"74": "PI",
										"75": "PINS",
										"77": "0.84999999999999998",
										"78": "2022-01-31 00:00:00.0000000",
										"79": "2022-02-01 14:30:26.0000000"
									},
									{
										"0": "00500012",
										"1": "Tracey",
										"2": "Jones",
										"3": "01049727",
										"4": "1900",
										"5": "PINS",
										"6": "P600",
										"7": "Strategy",
										"8": "P615",
										"9": "Strat Change",
										"10": "60004065",
										"11": "Change Portfolio",
										"12": "P6000000090640",
										"14": "PE",
										"15": "Permanent",
										"16": "01",
										"17": "Permanent Contract",
										"18": "G7",
										"19": "Grade 7",
										"20": "100",
										"21": "37",
										"22": "No",
										"23": "3",
										"24": "Active",
										"25": "Female",
										"26": "00/00/0000",
										"27": "00/00/0000",
										"30": "104972",
										"31": "02",
										"32": "Promotion",
										"33": "70012412",
										"34": "Change Portfolio Lead",
										"35": "90640",
										"36": "Project Man Office",
										"37": "1986-06-09 00:00:00.0000000",
										"38": "4/1/2020",
										"39": "00/00/0000",
										"40": "2000-08-07 00:00:00.0000000",
										"41": "00500140",
										"42": "Sean Canavan",
										"43": "70012401",
										"44": "Head of Strategy & Change",
										"45": "Christine Thorby",
										"46": "001",
										"47": "Bristol",
										"48": "1992-04-06 00:00:00.0000000",
										"49": "00/00/0000",
										"50": "00/00/0000",
										"51": "00/00/0000",
										"52": "1",
										"53": "Employee",
										"54": "xxxx",
										"55": "GBP",
										"57": "6/22/1968",
										"74": "PI",
										"75": "PINS",
										"77": "1",
										"78": "2022-01-31 00:00:00.0000000",
										"79": "2022-02-01 14:30:26.0000000"
									},
									{
										"0": "00500015",
										"1": "Susan",
										"2": "Doran",
										"3": "08141640",
										"4": "1900",
										"5": "PINS",
										"6": "P500",
										"7": "Operations",
										"8": "P510",
										"9": "Ops Group 2",
										"10": "60004142",
										"11": "Inquiries & Specialist Group 5",
										"12": "P5000000090220",
										"14": "PE",
										"15": "Permanent",
										"16": "01",
										"17": "Permanent Contract",
										"18": "BAND 2",
										"19": "Band 2 Inspector",
										"20": "70",
										"21": "37",
										"22": "Yes",
										"23": "3",
										"24": "Active",
										"25": "Female",
										"26": "00/00/0000",
										"27": "00/00/0000",
										"30": "814164",
										"31": "01",
										"32": "Change to Hours",
										"33": "70012848",
										"34": "Inspector",
										"35": "90220",
										"36": "Inspectr Costs",
										"37": "2002-07-15 00:00:00.0000000",
										"39": "00/00/0000",
										"40": "2014-08-01 00:00:00.0000000",
										"41": "00500318",
										"42": "Heidi Cruickshank",
										"43": "70012710",
										"44": "Inspector Manager",
										"45": "Kathryn Dunne",
										"46": "003",
										"47": "Home",
										"48": "2002-07-15 00:00:00.0000000",
										"49": "00/00/0000",
										"50": "00/00/0000",
										"51": "00/00/0000",
										"52": "1",
										"53": "Employee",
										"54": "xxxx",
										"55": "GBP",
										"57": "6/13/1961",
										"74": "PI",
										"75": "PINS",
										"77": "0.69999999999999996",
										"78": "2022-01-31 00:00:00.0000000",
										"79": "2022-02-01 14:30:26.0000000"
									},
									{
										"0": "00500016",
										"1": "Karen",
										"2": "Ridge",
										"3": "08148160",
										"4": "1900",
										"5": "PINS",
										"6": "P500",
										"7": "Operations",
										"8": "P510",
										"9": "Ops Group 2",
										"10": "60004137",
										"11": "Infrastructure & Inquiries Group 5",
										"12": "P5000000090220",
										"14": "PE",
										"15": "Permanent",
										"16": "01",
										"17": "Permanent Contract",
										"18": "BAND 3",
										"19": "Band 3 Inspector",
										"20": "70",
										"21": "37",
										"22": "Yes",
										"23": "3",
										"24": "Active",
										"25": "Female",
										"26": "00/00/0000",
										"27": "00/00/0000",
										"30": "814816",
										"31": "01",
										"32": "Change to Hours",
										"33": "70012803",
										"34": "Inspector",
										"35": "90220",
										"36": "Inspectr Costs",
										"37": "2005-09-01 00:00:00.0000000",
										"39": "00/00/0000",
										"40": "2015-05-01 00:00:00.0000000",
										"41": "00500313",
										"42": "Lesley Coffey",
										"43": "70012705",
										"44": "Inspector Manager",
										"45": "Chris White",
										"46": "001",
										"47": "Bristol",
										"48": "2005-09-01 00:00:00.0000000",
										"49": "00/00/0000",
										"50": "00/00/0000",
										"51": "00/00/0000",
										"52": "1",
										"53": "Employee",
										"54": "xxxx",
										"55": "GBP",
										"57": "5/27/1966",
										"74": "PI",
										"75": "PINS",
										"77": "0.69999999999999996",
										"78": "2022-01-31 00:00:00.0000000",
										"79": "2022-02-01 14:30:26.0000000"
									}
								],
								"schema": [
									{
										"key": "0",
										"name": "Pers_No",
										"type": "string"
									},
									{
										"key": "1",
										"name": "First_name",
										"type": "string"
									},
									{
										"key": "2",
										"name": "Last_name",
										"type": "string"
									},
									{
										"key": "3",
										"name": "Employee_No",
										"type": "string"
									},
									{
										"key": "4",
										"name": "CoCd",
										"type": "string"
									},
									{
										"key": "5",
										"name": "Company_Code",
										"type": "string"
									},
									{
										"key": "6",
										"name": "PA",
										"type": "string"
									},
									{
										"key": "7",
										"name": "Personnel_Area",
										"type": "string"
									},
									{
										"key": "8",
										"name": "PSubarea",
										"type": "string"
									},
									{
										"key": "9",
										"name": "Personnel_Subarea",
										"type": "string"
									},
									{
										"key": "10",
										"name": "Org_unit",
										"type": "string"
									},
									{
										"key": "11",
										"name": "Organizational_Unit",
										"type": "string"
									},
									{
										"key": "12",
										"name": "Organizational_key",
										"type": "string"
									},
									{
										"key": "13",
										"name": "Organizational_Key1",
										"type": "string"
									},
									{
										"key": "14",
										"name": "WorkC",
										"type": "string"
									},
									{
										"key": "15",
										"name": "Work_Contract",
										"type": "string"
									},
									{
										"key": "16",
										"name": "CT",
										"type": "string"
									},
									{
										"key": "17",
										"name": "Contract_Type",
										"type": "string"
									},
									{
										"key": "18",
										"name": "PS_group",
										"type": "string"
									},
									{
										"key": "19",
										"name": "Pay_Band_Description",
										"type": "string"
									},
									{
										"key": "20",
										"name": "FTE",
										"type": "string"
									},
									{
										"key": "21",
										"name": "Wk_hrs",
										"type": "string"
									},
									{
										"key": "22",
										"name": "Indicator_Part-Time_Employee",
										"type": "string"
									},
									{
										"key": "23",
										"name": "S",
										"type": "string"
									},
									{
										"key": "24",
										"name": "Employment_Status",
										"type": "string"
									},
									{
										"key": "25",
										"name": "Gender_Key",
										"type": "string"
									},
									{
										"key": "26",
										"name": "TRA_Start_Date",
										"type": "string"
									},
									{
										"key": "27",
										"name": "TRA_End_Date",
										"type": "string"
									},
									{
										"key": "28",
										"name": "TRA_Status",
										"type": "string"
									},
									{
										"key": "29",
										"name": "TRA_Grade",
										"type": "string"
									},
									{
										"key": "30",
										"name": "Prev_PersNo",
										"type": "string"
									},
									{
										"key": "31",
										"name": "ActR",
										"type": "string"
									},
									{
										"key": "32",
										"name": "Reason_for_Action",
										"type": "string"
									},
									{
										"key": "33",
										"name": "Position",
										"type": "string"
									},
									{
										"key": "34",
										"name": "Position1",
										"type": "string"
									},
									{
										"key": "35",
										"name": "Cost_Ctr",
										"type": "string"
									},
									{
										"key": "36",
										"name": "Cost_Centre",
										"type": "string"
									},
									{
										"key": "37",
										"name": "Civil_Service_Start",
										"type": "string"
									},
									{
										"key": "38",
										"name": "Date_to_Current_Job",
										"type": "string"
									},
									{
										"key": "39",
										"name": "Seniority_Date",
										"type": "string"
									},
									{
										"key": "40",
										"name": "Date_to_Subst__Grade",
										"type": "string"
									},
									{
										"key": "41",
										"name": "Pers_No_1",
										"type": "string"
									},
									{
										"key": "42",
										"name": "Name_of_Manager_OM",
										"type": "string"
									},
									{
										"key": "43",
										"name": "Manager_Position",
										"type": "string"
									},
									{
										"key": "44",
										"name": "Manager_Position_Text",
										"type": "string"
									},
									{
										"key": "45",
										"name": "Counter_Sign_Manager",
										"type": "string"
									},
									{
										"key": "46",
										"name": "Loc",
										"type": "string"
									},
									{
										"key": "47",
										"name": "Location",
										"type": "string"
									},
									{
										"key": "48",
										"name": "Org_Start_Date",
										"type": "string"
									},
									{
										"key": "49",
										"name": "Fix_Term_End_Date",
										"type": "string"
									},
									{
										"key": "50",
										"name": "Loan_Start_Date",
										"type": "string"
									},
									{
										"key": "51",
										"name": "Loan_End_Date",
										"type": "string"
									},
									{
										"key": "52",
										"name": "EEGrp",
										"type": "string"
									},
									{
										"key": "53",
										"name": "Employee_Group",
										"type": "string"
									},
									{
										"key": "54",
										"name": "Annual_salary",
										"type": "string"
									},
									{
										"key": "55",
										"name": "Curr",
										"type": "string"
									},
									{
										"key": "56",
										"name": "NI_number",
										"type": "string"
									},
									{
										"key": "57",
										"name": "Birth_date",
										"type": "string"
									},
									{
										"key": "58",
										"name": "Age_of_employee",
										"type": "string"
									},
									{
										"key": "59",
										"name": "EO",
										"type": "string"
									},
									{
										"key": "60",
										"name": "Ethnic_origin",
										"type": "string"
									},
									{
										"key": "61",
										"name": "NID",
										"type": "string"
									},
									{
										"key": "62",
										"name": "Rel",
										"type": "string"
									},
									{
										"key": "63",
										"name": "Religious_Denomination_Key",
										"type": "string"
									},
									{
										"key": "64",
										"name": "SxO",
										"type": "string"
									},
									{
										"key": "65",
										"name": "Wage_Type",
										"type": "string"
									},
									{
										"key": "66",
										"name": "Employee_Subgroup",
										"type": "string"
									},
									{
										"key": "67",
										"name": "LOA_Abs_Type",
										"type": "string"
									},
									{
										"key": "68",
										"name": "LOA_Absence_Type_Text",
										"type": "string"
									},
									{
										"key": "69",
										"name": "Scheme_reference",
										"type": "string"
									},
									{
										"key": "70",
										"name": "Pension_Scheme_Name",
										"type": "string"
									},
									{
										"key": "71",
										"name": "Disability_Code",
										"type": "string"
									},
									{
										"key": "72",
										"name": "Disability_Text",
										"type": "string"
									},
									{
										"key": "73",
										"name": "Disability_Code_Description",
										"type": "string"
									},
									{
										"key": "74",
										"name": "PArea",
										"type": "string"
									},
									{
										"key": "75",
										"name": "Payroll_Area",
										"type": "string"
									},
									{
										"key": "76",
										"name": "Assignment_Number",
										"type": "string"
									},
									{
										"key": "77",
										"name": "FTE_2",
										"type": "string"
									},
									{
										"key": "78",
										"name": "Report_MonthEnd_Date",
										"type": "string"
									},
									{
										"key": "79",
										"name": "PDAC_ETL_Date",
										"type": "string"
									}
								],
								"truncated": false
							},
							"isSummary": false,
							"language": "scala"
						},
						"persist_state": {
							"view": {
								"type": "details",
								"chartOptions": {
									"chartType": "bar",
									"aggregationType": "count",
									"categoryFieldKeys": [
										"0"
									],
									"seriesFieldKeys": [
										"0"
									],
									"isStacked": false
								}
							}
						}
					}
				}
			},
			"enableDebugMode": false,
			"kernelspec": {
				"name": "synapse_pyspark",
				"display_name": "Synapse PySpark"
			},
			"language_info": {
				"name": "python"
			},
			"a365ComputeOptions": {
				"id": "/subscriptions/ff442a29-fc06-4a13-8e3e-65fd5da513b3/resourceGroups/pins-odw-data-dev-rg/providers/Microsoft.Synapse/workspaces/pins-odw-data-dev-syn-ws/bigDataPools/pinsodwspark",
				"name": "pinsodwspark",
				"type": "Spark",
				"endpoint": "https://pins-odw-data-dev-syn-ws.dev.azuresynapse.net/livyApi/versions/2019-11-01-preview/sparkPools/pinsodwspark",
				"auth": {
					"type": "AAD",
					"authResource": "https://dev.azuresynapse.net"
				},
				"sparkVersion": "3.1",
				"nodeCount": 3,
				"cores": 4,
				"memory": 28,
				"extraHeader": null
			},
			"sessionKeepAliveTimeout": 30
		},
		"cells": [
			{
				"cell_type": "code",
				"source": [
					"raw_storage_container = 'abfss://odw-raw@pinsodwdatadevstorage.dfs.core.windows.net'\r\n",
					"raw_storage_source_folder = 'sap-load-tables'\r\n",
					"raw_storage_source_name = 'sap-hr'\r\n",
					"workspace_storage_container = 'abfss://odw-workspace@pinsodwdatadevstorage.dfs.core.windows.net'\r\n",
					"workspace_storage_temp_folder = 'sap-load-tables'\r\n",
					"workspace_storage_temp_name = 'sap-hr'\r\n",
					"standardised_storage_container = 'abfss://odw-standardised@pinsodwdatadevstorage.dfs.core.windows.net'\r\n",
					"standardised_storage_delta_folder = 'sap-load-tables'\r\n",
					"standardised_storage_delta_table_name = 'sap-hr'"
				],
				"attachments": null,
				"execution_count": 34
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"from pyspark.sql.types import *\r\n",
					"\r\n",
					"raw_storage_folder_path = raw_storage_container   + '/' + raw_storage_source_folder + '/' + raw_storage_source_name\r\n",
					"workspace_storage_folder_path = workspace_storage_container + '/' + workspace_storage_temp_folder + '/' + workspace_storage_temp_name\r\n",
					"sourceColumnNames = 'Pers_No,First_name,Last_name,Employee_No,CoCd,Company_Code,PA,Personnel_Area,PSubarea,Personnel_Subarea,Org_unit,Organizational_Unit,Organizational_key,Organizational_Key1,WorkC,Work_Contract,CT,Contract_Type,PS_group,Pay_Band_Description,FTE,Wk_hrs,Indicator_Part-Time_Employee,S,Employment_Status,Gender_Key,TRA_Start_Date,TRA_End_Date,TRA_Status,TRA_Grade,Prev_PersNo,ActR,Reason_for_Action,Position,Position1,Cost_Ctr,Cost_Centre,Civil_Service_Start,Date_to_Current_Job,Seniority_Date,Date_to_Subst__Grade,Pers_No_1,Name_of_Manager_OM,Manager_Position,Manager_Position_Text,Counter_Sign_Manager,Loc,Location,Org_Start_Date,Fix_Term_End_Date,Loan_Start_Date,Loan_End_Date,EEGrp,Employee_Group,Annual_salary,Curr,NI_number,Birth_date,Age_of_employee,EO,Ethnic_origin,NID,Rel,Religious_Denomination_Key,SxO,Wage_Type,Employee_Subgroup,LOA_Abs_Type,LOA_Absence_Type_Text,Scheme_reference,Pension_Scheme_Name,Disability_Code,Disability_Text,Disability_Code_Description,PArea,Payroll_Area,Assignment_Number,FTE_2,Report_MonthEnd_Date,PDAC_ETL_Date'\r\n",
					"\r\n",
					"sourceColumnNamesList = sourceColumnNames.split (\",\")\r\n",
					"sourceStructString = StructType()\r\n",
					"for sourceColumn in sourceColumnNamesList:\r\n",
					"    sourceStructString.add(StructField(sourceColumn ,StringType(), True))\r\n",
					"\r\n",
					"\r\n",
					"rawsourceDF=spark.read.option(\"delimiter\", \"|\").option(\"header\", \"true\").schema(sourceStructString).csv(raw_storage_folder_path)\r\n",
					"\r\n",
					"rawsourceDF.write.option(\"header\", \"true\").format('parquet').mode('overwrite').save(workspace_storage_folder_path)\r\n",
					""
				],
				"attachments": null,
				"execution_count": 61
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"# Import modules\r\n",
					"from delta.tables import DeltaTable\r\n",
					"\r\n",
					"delta_lake_table_key_column = 'Pers_no'\r\n",
					"\r\n",
					"standardised_storage_delta_table_path = standardised_storage_container + '/' + standardised_storage_delta_folder + '/' + standardised_storage_delta_table_name\r\n",
					"\r\n",
					"sourceParquetDF = spark.read.option(\"inferSchema\",\"true\").format('parquet').option(\"recursiveFileLookup\", \"true\").load(workspace_storage_folder_path)\r\n",
					"\r\n",
					"if (DeltaTable.isDeltaTable(spark,standardised_storage_delta_table_path)):\r\n",
					"    deltaTable = DeltaTable.forPath(spark,standardised_storage_delta_table_path)\r\n",
					"    # Merge new data into existing table\r\n",
					"    deltaTable.alias(\"existing\").merge(\r\n",
					"        source=sourceParquetDF.alias(\"updates\"),\r\n",
					"        condition=\"existing.\" + delta_lake_table_key_column + \" = updates.\" + delta_lake_table_key_column  # We look for matches on the name column\r\n",
					"    ).whenMatchedUpdateAll(\r\n",
					"    ).whenNotMatchedInsertAll(\r\n",
					"    ).execute()\r\n",
					"\r\n",
					"\r\n",
					"\r\n",
					"else:\r\n",
					"    sourceParquetDF.write.format('delta').save(standardised_storage_delta_table_path)\r\n",
					"    spark.sql(\"CREATE TABLE sap_hr USING DELTA LOCATION '{0}'\".format(standardised_storage_delta_table_path))"
				],
				"attachments": null,
				"execution_count": 62
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"# Get all versions\r\n",
					"delta_table = DeltaTable.forPath(spark, standardised_storage_delta_table_path)\r\n",
					"display(delta_table.history())"
				],
				"attachments": null,
				"execution_count": 63
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"microsoft": {
						"language": "sparksql"
					},
					"collapsed": false
				},
				"source": [
					"%%sql\r\n",
					"select * from default.sap_hr where pdac_etl_date > '2022-02-01 14:30:26.0000000'"
				],
				"attachments": null,
				"execution_count": 69
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					},
					"collapsed": false
				},
				"source": [
					"##select * from default.sap_hr TIMESTAMP AS OF \"2022-02-24 15:41:47.719\"\r\n",
					"incrementaldf = spark.read \\\r\n",
					"  .format(\"delta\") \\\r\n",
					"  .option(\"timestampAsOf\", \"2022-02-24 15:39:38.462\") \\\r\n",
					"  .load(standardised_storage_delta_table_path)\r\n",
					"\r\n",
					"display(incrementaldf.limit(5))"
				],
				"attachments": null,
				"execution_count": 75
			},
			{
				"cell_type": "code",
				"metadata": {
					"jupyter": {
						"source_hidden": false,
						"outputs_hidden": false
					},
					"nteract": {
						"transient": {
							"deleting": false
						}
					}
				},
				"source": [
					""
				],
				"attachments": null,
				"execution_count": null
			}
		]
	}
}