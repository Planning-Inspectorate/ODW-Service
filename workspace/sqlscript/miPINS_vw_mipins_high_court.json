{
	"name": "miPINS_vw_mipins_high_court",
	"properties": {
		"description": "PBI View for High Court",
		"folder": {
			"name": "High Court"
		},
		"content": {
			"query": "IF NOT EXISTS ( SELECT  *\n                FROM    sys.schemas\n                WHERE   name = 'miPINS' )\n    EXEC('CREATE SCHEMA [miPINS]');\nGO\n\n\nCREATE OR ALTER VIEW miPINS.vw_mipins_high_court\nAS\n--Table Alias Key: \n\n--HCD   = [odw_harmonised_db].[dbo].[high_court_dim]\n--CF    = [odw_harmonised_db].[dbo].[casework_case_fact]\n--CAAD  = [odw_harmonised_db].[dbo].[casework_all_appeals_dim]\n--HBE   = [odw_harmonised_db].[dbo].[casework_event_dim]\n\n\nSELECT DISTINCT\nHCD.AppealRefNumber                                             AS [AppNum],\nHCD.HCRef                                                       AS [HC Ref],\nHCD.CaseName                                                    AS [Case Name],\nHCD.GLList                                                      AS [GL List],\nHCD.[Procedure]                                                 AS [Procedure Type],\nHCD.ClaimDate                                                   AS [Claim Date],\nHCD.AppealType                                                  AS [Appeal Type],\nHCD.Challenge                                                   AS [Challenge Type],\nHCD.IsPCO                                                       AS [Protective Costs Order Applications Flag],\nHCD.DateOfDL                                                    AS [Date Of Appeal Decision Letter],\nHCD.FileToDIROrIMDate                                           AS [Date Inspector Comments Requested],\nHCD.ICToTSDDate                                                 AS [Date Inspector Comments sent to GLD],\nHCD.AdviceDate                                                  AS [Date GLD Advice Received],\nHCD.InstToTSDDate                                               AS [Date Instruction Sent to GLD],\nHCD.Instruct                                                    AS [PINS Instruction],\nHCD.ConsentDate                                                 AS [Date of Final Consent Order],\nHCD.DateOfHearing                                               AS [Date of Hearing],\nHCD.Outcome                                                     AS [Court Outcome],\nHCD.CourtDate                                                   AS [Date of Sealed Court Order],\nHCD.TranscriptDate                                              AS [Date of Final Judgement],\nHCD.IsAppeal                                                    AS [Seeking Court of Appeal Flag],\nHCD.Applicant                                                   AS [Applicant],\nHCD.SSEDefend                                                   AS [SSE Defend],\nHCD.Outcome2                                                    AS [Outcome CoA],\nHCD.CourtOrderDate                                              AS [Date of Court Order],\nHCD.TranscriptReceivedDate                                      AS [Date Transcript Received],\nHCD.PINSAA                                                      AS [PINS AA for Redetermined],\nHCD.IsOriginal                                                  AS [SC Flag],\nHCD.Outcome2                                                    AS [SC Outcome],\nHCD.IsRedet                                                     AS [RD Flag],\nHCD.RedetFile                                                   AS [RD File],\nHCD.RedetMinute                                                 AS [RD Minute],\nHCD.AreCostsToBeWrittenOff                                      AS [Costs to be Written Off Flag],\nHCD.CaseCosts                                                   AS [Costs Type],\nHCD.CaseStatus                                                  AS [Costs Status],\nHCD.CaseAmount                                                  AS [Costs Amount],\nHCD.InvoiceDate                                                 AS [Costs Invoice Date],\nHCD.DebtRecoveryDate                                            AS [Date Referred for Debt Recovery],\nHCD.PaymentReceivedDate                                         AS [Payment Received Date],\nCAAD.AppealRecDate                                              AS [Appeal Received Date],\nHCD.ValidTo                                                     AS [Appeal Valid Date],\nHBE.hzn_event_date                                              AS [Appeal Event Date],\nCAAD.AppealDecidedDate                                          AS [Appeal Decision Date],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.IsWelshOffice='True' \n        THEN 'Wales'\n            ELSE 'England'\nEND                                                             AS Country,\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.HCRef LIKE 'HC%' \n        THEN 'HC'\n     WHEN HCD.HCRef LIKE 'DPD%' \n        THEN 'DPD'\n\t WHEN HCD.HCRef LIKE 'NSIP%' \n        THEN 'NSIP'\n\t WHEN HCD.HCRef LIKE 'RoW%' \n        THEN 'RoW'\n\t WHEN HCD.HCRef LIKE 'SOS%' \n        THEN 'SOS'\n            ELSE 'OTHER'\nEND                                                             AS [Claim Type],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.AppealRefNumber IS NULL \n        THEN 'N'\n     WHEN HCD.AppealRefNumber IS NOT NULL \n        THEN 'Y'\nEND                                                             AS [PINS Appeal Flag],\n--------------------------------------------------------------------------------------------------------\nDATEDIFF(WK,HCD.DateOfDL,HCD.ClaimDate)                         AS [Date Of Decision to Date Claim - Weeks],\nCASE WHEN ISNULL(HCD.ConsentDate,'2099-01-01') <= ISNULL(HCD.CourtDate,'2099-01-01') \n     AND ISNULL(HCD.ConsentDate,'2099-01-01') <= ISNULL(HCD.TranscriptDate,'2099-01-01') \n        THEN HCD.ConsentDate\n\t  WHEN ISNULL(HCD.CourtDate,'2099-01-01') <= ISNULL(HCD.ConsentDate,'2099-01-01') \n      AND ISNULL(HCD.CourtDate,'2099-01-01') <= ISNULL(HCD.TranscriptDate,'2099-01-01') \n        THEN HCD.CourtDate\n            ELSE HCD.TranscriptDate\nEND                                                             AS [HC Outcome Date],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN ISNULL(HCD.CourtOrderDate,'2099-01-01') <= ISNULL(HCD.TranscriptReceivedDate,'2099-01-01')  \n        THEN HCD.CourtOrderDate\n            ELSE HCD.TranscriptReceivedDate\nEND                                                             AS [COA Outcome Date],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.Outcome IS NULL \n     AND HCD.Outcome2 IS NULL \n     AND HCD.SSEOutcome IS NULL \n        THEN 'OPEN'\n\t WHEN HCD.Outcome IS NOT NULL OR HCD.Outcome2 IS NOT NULL \n     AND HCD.SSEOutcome IS NOT NULL \n        THEN 'CLOSED'\nEND                                                             AS [Status],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.IsOriginal = 'True' \n     AND HCD.SSEOutcome IS NULL \n        THEN 'Supreme Court'\n\t WHEN HCD.IsAppeal = 'True' \n     AND HCD.Outcome2 IS NULL \n        THEN 'Court of Appeal'\n\t WHEN HCD.InstToTSDDate IS NOT NULL \n        THEN 'Instruction to GLD Sent'\n\t WHEN HCD.AdviceDate IS NOT NULL \n        THEN 'GLD Advice Received'\n\t WHEN HCD.ICToTSDDate IS NOT NULL \n        THEN 'Inspector Comments to GLD'\n\t WHEN HCD.FileToDIROrIMDate IS NOT NULL \n        THEN 'Inspector Comments Requested'\nEND                                                             AS [Open Stage],\n--------------------------------------------------------------------------------------------------------\nDATEDIFF(WK,HCD.FileToDIROrIMDate,HCD.ICToTSDDate)              AS [IC Comment Requested to Received - Weeks],\n\nCASE WHEN HCD.Outcome IS NOT NULL \n     AND HCD.Outcome2 IS NOT NULL \n        THEN 'Court of Appeal'\n\t  WHEN HCD.Outcome IS NOT NULL \n        THEN 'High Court'\n\t  WHEN HCD.Outcome2 IS NOT NULL \n        THEN 'Court of Appeal'\n\t  WHEN HCD.SSEOutcome IS NOT NULL \n        THEN 'Supreme Court'\nEND                                                             AS [Claim End Type],\n--------------------------------------------------------------------------------------------------------\nDATEDIFF(dd,HCD.ClaimDate,GETDATE())/7 AS [Age as of Today (In Weeks)],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.Outcome IN ('Perm. Refused', 'Struck Out', 'Withdrawn', 'Won') \n        THEN 'Y'\n            ELSE 'N'\nEND                                                             AS [HC Win],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.SSEOutcome IN ('Perm R', 'Withdrawn', 'Won') \n        THEN 'Y'\n            ELSE 'N'\nEND                                                             AS [COA Win],\n--------------------------------------------------------------------------------------------------------\nCASE WHEN HCD.Challenge = 's288' \n        THEN 'Planning'\n\t WHEN HCD.Challenge IN ('s289', 's288/s289') \n        THEN 'Enforcement'\n\t WHEN HCD.Challenge = 'JR' \n        THEN 'JR'\n\t WHEN HCD.Challenge IN ('s113','Other') \n        THEN 'Other'\n\t WHEN HCD.Challenge = 'PAP' \n        THEN 'PAP'\n\t        ELSE HCD.Challenge\nEND                                                             AS [Challenge Grouping]\n\nFROM [odw_harmonised_db].[dbo].[high_court_dim]                 AS HCD\nLEFT JOIN [odw_harmonised_db].[dbo].[casework_case_fact]        AS CF\n    ON CF.AppealRefNumber = HCD.AppealRefNumber\nLEFT JOIN [odw_harmonised_db].[dbo].[casework_all_appeals_dim]  AS CAAD\n    ON CAAD.AppealRefNumber = CF.AppealRefNumber\nLEFT JOIN [odw_standardised_db].[dbo].[horizon_bis_event]       AS HBE\n    ON HBE.Appeal_Reference_Number = CF.AppealRefNumber\n--WHERE HCD.AppealRefNumber = '3178530'\n\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "odw_curated_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}