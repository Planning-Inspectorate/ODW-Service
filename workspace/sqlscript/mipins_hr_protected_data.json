{
	"name": "mipins_hr_protected_data",
	"properties": {
		"folder": {
			"name": "archive/HR"
		},
		"content": {
			"query": "IF NOT EXISTS ( SELECT  *\n                FROM    sys.schemas\n                WHERE   name = 'miPINS' )\n    EXEC('CREATE SCHEMA [miPINS]');\nGO\n\n--CREATE VIEW FOR PROTECTED DATA--\n\nCREATE OR ALTER VIEW miPINS.vw_mipins_hr_protected_data\n\nAS\n\nSELECT DISTINCT\n\t\tT10.CalendarDate AS PCDate,\n\t\tLEFT(T10.CalendarMonth,3) AS PCMonth,\n\t\tT10.MonthOfYear AS MonthInt,\n\t\tconcat(LEFT(T10.CalendarMonth,3),' - ', RIGHT(T10.CalendarYear, 2)) AS PCMonthLatest, \n\t\tconcat('-',T10.CalendarYear,RIGHT(100+T10.MonthOfYear,2)) AS MonthYearLatestSortKey,\n\t\tT10.CalendarYear AS PCYear,\n\t\tT10.FinancialYear AS PCFY,\n\t\tconcat('FY-',RIGHT(T10.FinancialYear, 2))  AS PCFYLatest,\n\t\tT10.FinancialYear AS FYLatestSortKey,\n\t\tT1.SourceID AS RefNumber,\n\t\tT2.DisabilityCode AS DisabilityText,\n\t\tCASE \n\t\t\tWHEN T2.Description IS NULL THEN 'No Record'\n\t\t\tWHEN T2.Description IN ('DISABLED','Yes') THEN 'Yes'\n\t\t\tWHEN T2.Description IN ('NOT DISABLED', 'No') THEN 'No'\n\t\t\tWHEN T2.Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose', '0') THEN 'Unknown'\n\t\tEND AS Disabled,\n\t\tT3.Description AS EthnicOrigin,\n\t\tCASE WHEN T3.Description IS NULL THEN 'No Record'\n\t\t\tWHEN T3.Description LIKE 'White%' THEN 'White'\n\t\t\tWHEN T3.Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0','Not known') THEN 'Unknown'\n\t\t   ELSE 'BME'\n\t\tEND AS Ethnicity,\n\t\tCASE\n\t\t\tWHEN T1.ReligionID IS NULL THEN 'NULL'\n\t\t\tELSE T4.ReligionCode \n\t\tEND AS ReligiousDenominationKey,\n\t\tCASE\n\t\t\tWHEN T4.ReligionCode IS NULL THEN 'No Record'\n\t\t\tWHEN T4.ReligionCode IN ('None','Agnostic / Atheist') OR LEFT(T4.ReligionCode,3) IN ('ath','agn') THEN 'Agnostic / Atheist'\n\t\t\tWHEN T4.ReligionCode = 'Christian' THEN 'Christian'\n\t\t\tWHEN T4.ReligionCode IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0') THEN 'Unknown'\n\t\t   \tELSE 'Other Religion'\n\t\tEND AS Religion,\n\t\tT5.Description AS SxO,\n\t\tCASE \n\t\t\tWHEN T5.Description IS NULL THEN 'No Record'\n\t\t\tWHEN T5.Description ='Heterosexual' THEN 'Heterosexual'\n\t\t\tWHEN LEFT(T5.Description,3) IN ('Gay','Les','Bis') THEN 'LGBT'\n\t\t\tWHEN T5.Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','Other','0') THEN 'Unknown'\n\t\t    ELSE 'Other'\n\t\tEND AS SexualOrientation,\n        '1' AS PCHeadcount,\n\t\tCASE \n\t\t\tWHEN T2.Description IS NULL OR T2.Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0','Not known') \n\t\t\t\tTHEN 'No Record or Data not supplied for one or more categories.'\n\t  \t    WHEN T3.Description IS NULL OR T3.Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0','Not known') \n\t\t\t\tTHEN 'No Record or Data not supplied for one or more categories.'\n\t\t\tWHEN T4.ReligionCode IS NULL OR T4.ReligionCode IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0','Not known') \n\t\t\t\tTHEN 'No Record or Data not supplied for one or more categories.'\n\t\t\tWHEN T5 .Description IS NULL OR T5 .Description IN ('PREFER NOT TO SAY','Not disclosed','Do not wish to disclose','Unknown','0','Not known') \n\t\t\t\tTHEN 'No Record or Data not supplied for one or more categories.'\n\t   \t\tELSE 'Records Complete'\n\t   END AS DataCompleteness\n\n\tFROM [odw_harmonised_db].[dbo].hr_secure_info_fact T1\n\tLEFT JOIN [odw_harmonised_db].[dbo].hr_disability_dim T2 ON T1.DisabilityID = T2.DisabilityID and T2.IsActive = 'Y'\n\tLEFT JOIN [odw_harmonised_db].[dbo].hr_diversity_dim T3 ON T1.DiversityID = T3.DiversityID and T3.IsActive = 'Y'\n\tLEFT JOIN [odw_harmonised_db].[dbo].hr_religion_dim T4 ON T1.ReligionID = T4.ReligionID and T4.IsActive = 'Y'\n\tLEFT JOIN [odw_harmonised_db].[dbo].hr_sxo_dim T5 ON T1.SXOID = T5.SXOID and T5.IsActive = 'Y'\n\tLEFT OUTER JOIN [default].[dbo].calendar_dim_plus T10 ON DATEADD(month, -1, T1.IngestionDate) = T10.CalendarDate\n\n    GO\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "odw_curated_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}