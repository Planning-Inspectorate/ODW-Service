{
	"name": "horizon_service_user",
	"properties": {
		"content": {
			"query": "WITH cases AS\n(\nSELECT DISTINCT\n      cases.CaseNodeId, \n      dtree.SubType,  \n      cases.CaseReference, \n      cases.CaseUniqueId                         AS case_number\n\nFROM\n      Horizon_CaseReference cases\n      INNER JOIN DTree dtree             ON cases.CaseNodeId = dtree.DataID\n      INNER JOIN Horizon_TypeOfCase t     ON cases.CaseTypeId = t.ID\nWHERE\n      dtree.OwnerID != '-235834'     -- Recycle bin ownerid\n)\n,\ncase_involvement(DataId, ContactID, ContactDetails, TypeOfInvolvement) AS\n       (SELECT DISTINCT d.DataId AS DataId, ll1.ValStr AS [ContactID], ll2.ValStr AS [ContactDetails], ll3.ValStr AS [TypeOfInvolvement]\n       FROM DTree d\n           INNER JOIN llattrdata ll1 ON d.DataId = ll1.Id\n           INNER JOIN llattrdata ll2 ON d.DataId = ll2.Id\n           INNER JOIN llattrdata ll3 ON d.DataId = ll3.Id\n       WHERE\n           ll1.DefId = 95501 AND ll1.AttrId = 20\n           AND ll2.DefId = 95501 AND ll2.AttrId = 19\n           AND ll3.DefId = 95501 AND ll3.AttrId = 3 \n           AND ll1.ParentKeyId = ll2.ParentKeyId\n           AND ll1.ParentKeyId = ll3.ParentKeyId)\n\n \n\nSELECT\n    cr.case_number,\n    D.CreateDate as case_created_date,\n    ci.ContactID,\n    ci.TypeOfInvolvement,\n    v.ContactType,\n    v.FirstName,\n    v.LastName,\n    v.PostName,\n    v.Title,\n    v.Salutation,\n    v.Suffix,\n    v.POBox,\n    v.Address1,\n    v.Address2,\n    v.City,\n    v.County,\n    v.Postcode,\n    v.Country,\n    v.TelephoneOffice,\n    v.TelephoneMobile,\n    v.Fax,\n    v.Email,\n    v.LPACode,\n    v.OrganisationName,\n    t.OrganisationTypeName\nFROM \n    cases cr WITH (NOLOCK)\n        INNER JOIN DTree D  WITH (NOLOCK) ON cr.CaseNodeId = D.DataID\n        INNER JOIN case_involvement ci on D.DataID = ci.DataId\n        LEFT JOIN [dbo].[Horizon_vw_AllContacts] v on ci.ContactID =v.Id\n        LEFT JOIN Contacts_OrganisationType t on v.OrganisationTypeID = t.ID",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}