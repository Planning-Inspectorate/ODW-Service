{
	"name": "mipins_hr_fact_sickness",
	"properties": {
		"content": {
			"query": "\n-- IPORTANT INFO : Prior to running this notebook you should update the calendar_dim_plus table, \n-- to get the most up to date informations regarding the columns which use the date \n-- To run update the table jus run the Calendar notebook \n\n\nIF NOT EXISTS ( SELECT  *\n                FROM    sys.schemas\n                WHERE   name = 'mipins' )\n    EXEC('CREATE SCHEMA [mipins]');\nGO\n\n-- CREATE VIEW FOR SICKNESS FACT--\n\nCREATE OR ALTER VIEW mipins.vw_mipins_hr_fact_sickness\nAS\n\nSELECT [StaffNumber],[Previous FY],[Current FY],[Previous CY],[Current CY]\nFROM(\nSELECT DISTINCT\n\nabs.EmployeeID AS StaffNumber,\ndate.financial_year AS MeasureYear,\nCOUNT(*) as SicknessCount\n\nFROM [odw_harmonised_db].[dbo].[hr_absence_dim] abs\nFULL JOIN [default].[dbo].[calendar_dim_plus] date on date.CalendarDate = abs.AbsenceEndDate\nWHERE AbsenceType in  ('Sickness') and financial_year in ('Current FY','Previous FY')\nGROUP BY EmployeeID\n      ,financial_year\n\n\nUNION\n\nSELECT DISTINCT\n\nabs.EmployeeID,\ndate.calendar_year AS MeasureYear,\nCOUNT(*) as SicknessCount\n\n\nFROM [odw_harmonised_db].[dbo].[hr_absence_dim] abs\nFULL JOIN [default].[dbo].[calendar_dim_plus] date on date.CalendarDate = abs.AbsenceEndDate\nWHERE AbsenceType in  ('Sickness') and calendar_year in ('Current CY','Previous CY')\nGROUP BY EmployeeID\n      ,calendar_year\n) AS SourceTable\nPIVOT\n(\nmax(SicknessCount)\nFOR MeasureYear IN ([Previous FY],[Current FY],[Previous CY],[Current CY])\n) AS PivotTable\n-- ORDER BY [StaffNumber]\n\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "odw_curated_db",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}