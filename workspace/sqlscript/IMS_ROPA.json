{
	"name": "IMS_ROPA",
	"properties": {
		"description": "Curated table for IMS_Ropa data for PBI reports",
		"content": {
			"query": " IF NOT EXISTS ( SELECT  *\n                 FROM    sys.schemas\n                 WHERE   name = 'miPINS' )\n     EXEC('CREATE SCHEMA [miPINS]');\n GO\n\n--CREATE VIEW FOR IMS ROPA--\n\n CREATE OR ALTER VIEW miPINS.vw_mipins_IMS_ROPA\n AS\n\n\nSELECT \n\tROPAID                                                                                          AS [ropa_id],\n    ROPAName                                                                                        AS [ropa_name],\n    ROPAType                                                                                        AS [type],\n    ROPAStatus                                                                                      AS [status],\n    ROPAPriority                                                                                    AS [priority],\n    ISNULL(REPLACE(ROPAOrganisationAreas, '^', ''))                                                 AS [organisation_areas_c],\n    ISNULL(REPLACE(ROPADataControllers, '^', ''))                                                   AS [data_controllers_c],\n    ROPAJointController                                                                             AS [joint_controller_c],\n    ROPACategoriesOfPersonalData                                                                    AS [categories_of_personal_data_c],\n    ROPACategoriesOfRecipients                                                                      AS [categories_of_recipients_c],\n    ROPASecurityMeasures                                                                            AS [security_measures_c],\n\n    CASE REPLACE(ThirdCountryNames, '^', '') \n        WHEN '' THEN NULL \n        ELSE REPLACE(ThirdCountryNames, '^', '') \n    END                                                                                             AS [third_country_names_c],\n\n    ThirdCountrySafeguards                                                                          AS [third_country_safeguards_c],\n    ROPALegitimateInterest                                                                          AS [legitimate_interest_c],\n    ISNULL(ROPAAutomatedDecisionMaking)                                                             AS [automated_decision_making_c], \n      ,[data_source_c]\n      ,[records_of_consent_c]\n      ,[location_of_data_c]\n      ,isnull(load.get_ims_display_name([dpia_required_c]), [dpia_required_c]) as [dpia_required_c]\n      ,isnull(load.get_ims_display_name([dpia_status_c]), [dpia_status_c]) as [dpia_status_c]\n      ,[retention_policy_c]\n      ,isnull(load.get_ims_display_name([retention_policy_applied_c]), [retention_policy_applied_c]) as [retention_policy_applied_c]\n      ,[data_breach_record_c]\n      ,[retention_not_adhered_c]\n      ,[privacy_notice_c]\n\t  ,case replace([categories_of_individuals_c], '^', '') when '' then null else replace([categories_of_individuals_c], '^', '') end as [categories_of_individuals_c]\n      ,[retention_schedule]\n      ,isnull(load.get_ims_display_name([business_function]), [business_function]) as business_function\n      ,[dpo]\n      ,isnull(load.get_ims_display_name([data_breach_occurred_c]), [data_breach_occurred_c]) as [data_breach_occurred_c]\n      ,[last_current_and_accurate_da_c]\n\n      --,isnull(load.get_ims_display_name([gdpr_lawful_basis_c]), [gdpr_lawful_basis_c]) as gdpr_lawful_basis_c\n      --,isnull(load.get_ims_display_name([gdpr_special_category_conditio]), [gdpr_special_category_conditio]) as [gdpr_special_category_conditio]\n      --,isnull(load.get_ims_display_name([dpa_2018_sch1_condition_c]), [dpa_2018_sch1_condition_c]) as dpa_2018_sch1_condition_c\n      --,[rights_of_data_subject_c]\n\n\t  ,load.get_ims_display_name(case [gdpr_lawful_basis_ms_c] when '^^' then null else replace(replace([gdpr_lawful_basis_ms_c], '^^', ','), '^', '') end) as [gdpr_lawful_basis_ms_c]\n\t  ,load.get_ims_display_name(case [gdpr_special_cat_condition_m_c] when '^^' then null else replace(replace([gdpr_special_cat_condition_m_c], '^^', ','), '^', '') end) as [gdpr_special_cat_condition_m_c]\n\t  ,load.get_ims_display_name(case [dpa_2018_sch1_condition_ms_c] when '^^' then null else replace(replace([dpa_2018_sch1_condition_ms_c], '^^', ','), '^', '') end) as [dpa_2018_sch1_condition_ms_c]\n\n\n      ,[business_function_unstructured]\n      ,[bdc_entity_temp_c]\n      ,[cat_of_individuals_temp_c]\n      ,[ims_ropa_documents_1] as [ims_ropa_documents]\n      ,[estimated_number_of_operator_c]\n      ,replace([information_owner_c], '&#039;', '''') as information_owner_c\n      ,replace([information_expert_c], '&#039;', '''') as information_expert_c\n\t  ,[date_modified]\n\n  FROM [odw_harmonised_db].[dbo].[ims_ropa_dim]",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}