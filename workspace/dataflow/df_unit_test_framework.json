{
	"name": "df_unit_test_framework",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"name": "StandardisedSource"
				},
				{
					"name": "HarmonisedSource"
				},
				{
					"name": "CuratedSource"
				},
				{
					"linkedService": {
						"referenceName": "ls_storage",
						"type": "LinkedServiceReference"
					},
					"name": "ConfigSource"
				},
				{
					"name": "OrchestrationSource"
				}
			],
			"sinks": [
				{
					"name": "TestResultOutput"
				}
			],
			"transformations": [
				{
					"name": "StandardisedCount"
				},
				{
					"name": "HarmonisedCount"
				},
				{
					"name": "CuratedCount"
				},
				{
					"name": "StdHrmJoin"
				},
				{
					"name": "RowCountComparison"
				},
				{
					"name": "TestResults"
				},
				{
					"name": "StandardisedFilter"
				}
			],
			"scriptLines": [
				"parameters{",
				"     entity_name as string ('appeal-document'),",
				"     std_db as string ('odw_standardised_db'),",
				"     hrm_db as string ('odw_harmonised_db'),",
				"     cur_db as string ('odw_curated_db'),",
				"     std_table as string ('sb_appeal_document'),",
				"     hrm_table as string ('sb_appeal_document'),",
				"     hrm_final as string ('appeal_document'),",
				"     cur_table as string ('appeal_document'),",
				"     primary_key as string ('documentId')",
				"}",
				"source(output(",
				"          id as long,",
				"          caseReference as string,",
				"          preparationTime as double,",
				"          sittingTime as double,",
				"          reportingTime as double,",
				"          ingested_datetime as timestamp,",
				"          expected_from as timestamp,",
				"          expected_to as timestamp,",
				"          message_id as string,",
				"          message_type as string,",
				"          message_enqueued_time_utc as string,",
				"          input_file as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($std_db),",
				"     tableName: ($std_table)) ~> StandardisedSource",
				"source(output(",
				"          AppealsEstimateEventID as long,",
				"          id as long,",
				"          caseReference as string,",
				"          preparationTime as double,",
				"          sittingTime as double,",
				"          reportingTime as double,",
				"          migrated as string,",
				"          ODTSourceSystem as string,",
				"          SourceSystemID as string,",
				"          IngestionDate as string,",
				"          ValidTo as string,",
				"          RowID as string,",
				"          IsActive as string,",
				"          message_id as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($hrm_db),",
				"     tableName: ($hrm_final)) ~> HarmonisedSource",
				"source(output(",
				"          id as long,",
				"          caseReference as string,",
				"          preparationTime as double,",
				"          sittingTime as double,",
				"          reportingTime as double",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($cur_db),",
				"     tableName: ($cur_table)) ~> CuratedSource",
				"source(useSchema: false,",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'json',",
				"     fileSystem: 'odw-config',",
				"     folderPath: 'standardised_table_definitions',",
				"     fileName: ($entity_name),",
				"     documentForm: 'documentPerLine') ~> ConfigSource",
				"source(output(",
				"          Source_ID as integer,",
				"          Source_Folder as string,",
				"          Horizon_Table_Name as string,",
				"          Source_Frequency_Folder as string,",
				"          Source_Filename_Format as string,",
				"          Source_Filename_Start as string,",
				"          Expected_Within_Weekdays as integer,",
				"          Standardised_Path as string,",
				"          Standardised_Table_Name as string,",
				"          Standardised_Table_Definition as string,",
				"          Harmonised_Table_Name as string,",
				"          Harmonised_Incremental_Key as string,",
				"          Entity_Primary_Key as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_config_db',",
				"     tableName: 'orchestration') ~> OrchestrationSource",
				"StandardisedFilter aggregate(std_count = count(1)) ~> StandardisedCount",
				"HarmonisedSource aggregate(groupBy(primaryKey = $primary_key),",
				"     hrm_count = count(1),",
				"          hrm_active_count = sum(iif(toString(byName('IsActive')) == 'Y', 1, 0))) ~> HarmonisedCount",
				"CuratedSource aggregate(groupBy(primaryKey = $primary_key),",
				"     cur_count = count(1),",
				"          cur_distinct_count = countDistinct($primary_key)) ~> CuratedCount",
				"StandardisedCount, HarmonisedCount join(1 == 1,",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> StdHrmJoin",
				"StdHrmJoin, CuratedCount join(1 == 1,",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> RowCountComparison",
				"RowCountComparison derive(entity = $entity_name,",
				"          std_to_hrm_match = std_count == hrm_count,",
				"          hrm_to_cur_match = hrm_active_count == cur_count,",
				"          cur_unique_check = cur_count == cur_distinct_count,",
				"          test_timestamp = currentTimestamp(),",
				"          std_hrm_diff = std_count - hrm_count,",
				"          hrm_cur_diff = hrm_active_count - cur_count) ~> TestResults",
				"StandardisedSource filter(!isNull(message_type) && !isNull(message_id) && in(['Create', 'update', 'Update', 'Publish', 'Unpublish', 'Delete'], message_type)) ~> StandardisedFilter",
				"TestResults sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'logging',",
				"     tableName: 'unit_test_results') ~> TestResultOutput"
			]
		}
	}
}