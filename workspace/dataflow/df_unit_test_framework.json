{
	"name": "df_unit_test_framework",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"name": "StandardisedSource"
				},
				{
					"name": "HarmonisedSource"
				},
				{
					"name": "CuratedSource"
				},
				{
					"linkedService": {
						"referenceName": "ls_storage",
						"type": "LinkedServiceReference"
					},
					"name": "ConfigSource"
				},
				{
					"name": "OrchestrationSource"
				}
			],
			"sinks": [
				{
					"name": "TestResultOutput"
				}
			],
			"transformations": [
				{
					"name": "StandardisedCount"
				},
				{
					"name": "HarmonisedCount"
				},
				{
					"name": "CuratedCount"
				},
				{
					"name": "RowCountComparison"
				},
				{
					"name": "TestResults"
				}
			],
			"scriptLines": [
				"parameters{",
				"     entity_name as string ('appeal-document'),",
				"     std_db as string ('odw_standardised_db'),",
				"     hrm_db as string ('odw_harmonised_db'),",
				"     cur_db as string ('odw_curated_db'),",
				"     std_table as string ('sb_appeal_document'),",
				"     hrm_table as string ('sb_appeal_document'),",
				"     hrm_final as string ('appeal_document'),",
				"     cur_table as string ('appeal_document'),",
				"     primary_key as string ('documentId')",
				"}",
				"source(output(",
				"          documentId as string,",
				"          caseId as long,",
				"          caseReference as string,",
				"          version as long,",
				"          filename as string,",
				"          originalFilename as string,",
				"          size as long,",
				"          mime as string,",
				"          documentURI as string,",
				"          publishedDocumentURI as string,",
				"          virusCheckStatus as string,",
				"          fileMD5 as string,",
				"          dateCreated as string,",
				"          dateReceived as string,",
				"          datePublished as string,",
				"          lastModified as string,",
				"          caseType as string,",
				"          redactedStatus as string,",
				"          documentType as string,",
				"          sourceSystem as string,",
				"          origin as string,",
				"          owner as string,",
				"          author as string,",
				"          description as string,",
				"          caseStage as string,",
				"          horizonFolderId as string,",
				"          ingested_datetime as timestamp,",
				"          expected_from as timestamp,",
				"          expected_to as timestamp,",
				"          message_id as string,",
				"          message_type as string,",
				"          message_enqueued_time_utc as string,",
				"          input_file as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($std_db),",
				"     tableName: ($std_table)) ~> StandardisedSource",
				"source(output(",
				"          AppealsDocumentMetadataID as integer,",
				"          documentId as string,",
				"          caseId as long,",
				"          caseReference as string,",
				"          version as long,",
				"          filename as string,",
				"          originalFilename as string,",
				"          size as long,",
				"          mime as string,",
				"          documentURI as string,",
				"          publishedDocumentURI as string,",
				"          virusCheckStatus as string,",
				"          fileMD5 as string,",
				"          dateCreated as string,",
				"          dateReceived as string,",
				"          datePublished as string,",
				"          lastModified as string,",
				"          caseType as string,",
				"          redactedStatus as string,",
				"          documentType as string,",
				"          sourceSystem as string,",
				"          origin as string,",
				"          owner as string,",
				"          author as string,",
				"          description as string,",
				"          caseStage as string,",
				"          horizonFolderId as string,",
				"          caseNumber as string,",
				"          caseworkTypeGroup as string,",
				"          caseworkTypeAbbreviation as string,",
				"          versionFilename as string,",
				"          incomingOutgoingExternal as string,",
				"          publishedStatus as string,",
				"          Migrated as string,",
				"          ODTSourceSystem as string,",
				"          IngestionDate as string,",
				"          ValidTo as string,",
				"          RowID as string,",
				"          IsActive as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($hrm_db),",
				"     tableName: ($hrm_final)) ~> HarmonisedSource",
				"source(output(",
				"          documentId as string,",
				"          caseId as long,",
				"          caseReference as string,",
				"          version as long,",
				"          filename as string,",
				"          originalFilename as string,",
				"          size as long,",
				"          mime as string,",
				"          documentURI as string,",
				"          publishedDocumentURI as string,",
				"          virusCheckStatus as string,",
				"          fileMD5 as string,",
				"          dateCreated as string,",
				"          dateReceived as string,",
				"          datePublished as string,",
				"          lastModified as string,",
				"          caseType as string,",
				"          redactedStatus as string,",
				"          documentType as string,",
				"          sourceSystem as string,",
				"          origin as string,",
				"          owner as string,",
				"          author as string,",
				"          description as string,",
				"          caseStage as string,",
				"          horizonFolderId as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: ($cur_db),",
				"     tableName: ($cur_table)) ~> CuratedSource",
				"source(useSchema: false,",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'json',",
				"     fileSystem: 'odw-config',",
				"     folderPath: 'standardised_table_definitions',",
				"     fileName: ($entity_name),",
				"     documentForm: 'documentPerLine') ~> ConfigSource",
				"source(output(",
				"          Source_ID as integer,",
				"          Source_Folder as string,",
				"          Horizon_Table_Name as string,",
				"          Source_Frequency_Folder as string,",
				"          Source_Filename_Format as string,",
				"          Source_Filename_Start as string,",
				"          Expected_Within_Weekdays as integer,",
				"          Standardised_Path as string,",
				"          Standardised_Table_Name as string,",
				"          Standardised_Table_Definition as string,",
				"          Harmonised_Table_Name as string,",
				"          Harmonised_Incremental_Key as string,",
				"          Entity_Primary_Key as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_config_db',",
				"     tableName: 'orchestration') ~> OrchestrationSource",
				"StandardisedSource aggregate(groupBy(documentId),",
				"     std_count = count(1),",
				"          std_with_message_type = sum(iif(isNull(message_type) || isNull(message_id), 0, 1))) ~> StandardisedCount",
				"HarmonisedSource aggregate(groupBy(documentId),",
				"     hrm_count = count(1),",
				"          hrm_active_count = sum(iif(toString(byName('IsActive')) == 'Y', 1, 0))) ~> HarmonisedCount",
				"CuratedSource aggregate(groupBy(documentId),",
				"     cur_count = count(1),",
				"          cur_distinct_count = countDistinct(byName($primary_key))) ~> CuratedCount",
				"StandardisedCount, HarmonisedCount, CuratedCount join(1 == 1,",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> RowCountComparison",
				"RowCountComparison derive(entity = $entity_name,",
				"          std_to_hrm_match = std_with_message_type == hrm_count,",
				"          hrm_to_cur_match = hrm_active_count == cur_count,",
				"          cur_unique_check = cur_count == cur_distinct_count,",
				"          test_timestamp = currentTimestamp(),",
				"          std_hrm_diff = std_with_message_type - hrm_count,",
				"          hrm_cur_diff = hrm_active_count - cur_count) ~> TestResults",
				"TestResults sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'logging',",
				"     tableName: 'unit_test_results') ~> TestResultOutput"
			]
		}
	}
}