{
	"name": "CompareCuratedAndHarmonised",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"name": "CuratedSource"
				},
				{
					"name": "HarmonisedSource"
				},
				{
					"name": "ServiceBusHarmonisedSource"
				},
				{
					"name": "StandardisedSource"
				},
				{
					"linkedService": {
						"referenceName": "ls_storage",
						"type": "LinkedServiceReference"
					},
					"name": "Schemas"
				}
			],
			"sinks": [
				{
					"name": "TestResultOutput"
				}
			],
			"transformations": [
				{
					"name": "HarmonisedCount"
				},
				{
					"name": "ServiceBusHarmonisedCount"
				},
				{
					"name": "CuratedCount"
				},
				{
					"name": "JoinTables"
				},
				{
					"name": "rowDifference"
				},
				{
					"name": "AssertSchema"
				}
			],
			"scriptLines": [
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_curated_db',",
				"     tableName: 's51_advice') ~> CuratedSource",
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_harmonised_db',",
				"     tableName: 'nsip_s51_advice') ~> HarmonisedSource",
				"source(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_harmonised_db',",
				"     tableName: 'sb_s51_advice') ~> ServiceBusHarmonisedSource",
				"source(output(",
				"          adviceId as long,",
				"          adviceReference as string,",
				"          caseId as long,",
				"          caseReference as string,",
				"          title as string,",
				"          titleWelsh as string,",
				"          from as string,",
				"          agent as string,",
				"          method as string,",
				"          enquiryDate as string,",
				"          enquiryDetails as string,",
				"          enquiryDetailsWelsh as string,",
				"          adviceGivenBy as string,",
				"          adviceDate as string,",
				"          adviceDetails as string,",
				"          adviceDetailsWelsh as string,",
				"          status as string,",
				"          redactionStatus as string,",
				"          attachmentIds as string[],",
				"          ingested_datetime as timestamp,",
				"          expected_from as timestamp,",
				"          expected_to as timestamp,",
				"          message_id as string,",
				"          message_type as string,",
				"          message_enqueued_time_utc as string,",
				"          input_file as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'odw_standardised_db',",
				"     tableName: 'sb_s51_advice') ~> StandardisedSource",
				"source(useSchema: false,",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     format: 'json',",
				"     fileSystem: 'odw-condfig',",
				"     folderPath: 'standardised_table_definitions/Horizon',",
				"     fileName: (@entity_name),",
				"     documentForm: 'documentPerLine') ~> Schemas",
				"HarmonisedSource aggregate(rowHarmonisedCount = sum(iif(toString(byName('IsActive')) == 'Y', 1, 0))) ~> HarmonisedCount",
				"ServiceBusHarmonisedSource aggregate(rowHorizonHarmonisedCount = count(1)) ~> ServiceBusHarmonisedCount",
				"CuratedSource aggregate(rowCuratedCount = count(1)) ~> CuratedCount",
				"CuratedCount, HarmonisedCount join(1 == 1,",
				"     joinType:'cross',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> JoinTables",
				"JoinTables derive(rowDifference = rowCuratedCount - (rowHarmonisedCount)) ~> rowDifference",
				"StandardisedSource assert(expectTrue(equals(columnNames(source1()), columnNames(source2())) && equals(columnTypes(source1()), columnTypes(source2())), false, '')) ~> AssertSchema",
				"rowDifference sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     store: 'synapse',",
				"     databaseType: 'spark',",
				"     format: 'table',",
				"     database: 'logging',",
				"     tableName: ('row_comparison.csv')) ~> TestResultOutput"
			]
		}
	}
}