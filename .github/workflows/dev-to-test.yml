###
# This pipeline automatically raises a PR from dev->test whenever something is pushed into dev
###
name: Create Pull Request from dev branch to test branch

on:
  push:
    branches:
      - dev

env:
  TEST_BRANCH_NAME: 'testing'

jobs:
  create_test_branch_and_raise_pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: dev
    - name: Check the $TEST_BRANCH_NAME branch exists
      shell: bash
      run: |
        if [ -n $(git ls-remote --heads origin $TEST_BRANCH_NAME) ]; then
            echo "createTestBranch=false" >> $GITHUB_OUTPUT
        else
            echo "createTestBranch=true" >> $GITHUB_OUTPUT          
        fi
      id: check_test_branch_exists
    - name: Extract most recent commit message
      shell: bash
      run: |
        delimiter=$(openssl rand -hex 8)
        echo "message<<$delimiter" >> $GITHUB_OUTPUT
        echo "${{ github.event.head_commit.message }}" >> $GITHUB_OUTPUT
        echo "$delimiter" >> $GITHUB_OUTPUT
      id: extract_commit_message
    - name: Raise Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        git config user.name "${GITHUB_ACTOR}"
        if [[ ${{ steps.check_test_branch_exists.outputs.createTestBranch }} ]]; then
            echo "The $TEST_BRANCH_NAME branch does not exist, creating the branch and raising a pull request"
            git fetch
            git checkout main
            git pull
            git checkout -b $TEST_BRANCH_NAME
            git push --set-upstream origin $TEST_BRANCH_NAME
            gh pr create -B dev -H $TEST_BRANCH_NAME --title 'Automated Pull Request from dev branch to $TEST_BRANCH_NAME branch' --body '${{ steps.extract_commit_message.outputs.message }}'
        else
            echo "The $TEST_BRANCH_NAME branch already exists, not raising a Pull Request"
        fi
