###
# This pipeline automatically raises a PR from dev->test whenever something is pushed into dev
###
name: Create Pull Request from dev branch to test branch

on:
  push:
    branches:
      - dev


jobs:
  create_test_branch_and_raise_pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: dev
    - name: Check the test branch exists
      shell: bash
      run: |
        if [[ -n $(git ls-remote --heads origin test) ]]; then
            echo "testBranchExists=true" >> $GITHUB_OUTPUT
        else
            echo "testBranchExists=false" >> $GITHUB_OUTPUT          
        fi
      id: check_test_branch_exists
    - name: Extract most recent commit message
      shell: bash
      run: |
        {
            echo "message<<\n"
            ${{ github.event.head_commit.message }}
            echo \n
        } >> $GITHUB_OUTPUT
      id: extract_commit_message
    - name: Raise Pull Request
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
        git config user.name "${GITHUB_ACTOR}"
        git pull
        export AVAILABLE_BRANCHES=$(git branch -r)
        
        if [[ ! ${{ steps.check_test_branch_exists.outputs.testBranchExists }}]]; then
            git branch test
            gh pr create -B dev -H test --title 'Automated Pull Request from dev branch to test branch' --body '${{ steps.extract_commit_message.outputs.message }}'
        fi
