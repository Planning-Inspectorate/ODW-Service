###
# This pipeline automatically raises a PR from dev->test whenever something is pushed into dev
###
name: Create Pull Request from dev branch to test branch

on:
  ppull_request:
    branches:
      - dev

env:
  TEST_BRANCH_NAME: 'testing'

jobs:
  create_test_branch_and_raise_pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        ref: dev
    - name: Check the ${{ env.TEST_BRANCH_NAME }} branch exists
      shell: bash
      run: |
        if [ -n $(git ls-remote --heads origin ${{ env.TEST_BRANCH_NAME }}) ]; then
            echo "createTestBranch=false" >> $GITHUB_OUTPUT
        else
            echo "createTestBranch=true" >> $GITHUB_OUTPUT          
        fi
      id: check_test_branch_exists
    - name: Extract most recent commit message
      shell: bash
      env:
        COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
      run: |
        delimiter=$(openssl rand -hex 8)
        echo "message<<$delimiter" >> $GITHUB_OUTPUT
        echo "$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "$delimiter" >> $GITHUB_OUTPUT
      id: extract_commit_message
    - name: Echo branch exists variable
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMIT_MESSAGE: ${{ steps.extract_commit_message.outputs.message }}
      run: |
        echo "${{ steps.check_test_branch_exists.outputs.createTestBranch }}"