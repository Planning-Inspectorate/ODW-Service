# How to add a new user to ODW

This SQL script can be run, either locally if you have a connection, or in Synapse.  

SQL script in Synapse: `add_user`  

Code: 

```sql

/*
CODE TO ADD A NEW USER. EXAMPLE BASED ON A MANAGED IDENTITY BUT CAN BE ADAPTED.

1. SPECIFY USER NAME OR APP NAME FOR @NEW_USER
2. SPECIFY THE DATABASE YOU WANT TO ADD THE USER TO
3. CREATE A LOGIN
4. RUN THE DROP USER CODE IN CASE IT ALREADY EXISTS - ERROR IF NOT FOUND WHICH IS FINE
5. RUN CREATE USER AND GRANT PERMISSION CODE TOGETHER, COMMENTING OUT THE DROP USER CODE
6. USE THE CODE SAMPLE BELOW TO CHECK THE CREATION AND ROLE ASSIGNMENTS  
*/

-- SET VARIABLES
DECLARE @NEW_USER NVARCHAR(MAX);
SET @NEW_USER = 'pins-fnapp01-odw-dev-uks';
DECLARE @DB NVARCHAR(MAX);
SET @DB = 'ODW_CURATED_DB';

--CREATE A LOGIN
DECLARE @CREATE_LOGIN NVARCHAR(MAX);
SET @CREATE_LOGIN = 'USE MASTER; CREATE LOGIN ' + QUOTENAME(@NEW_USER) + ' FROM EXTERNAL PROVIDER;';
EXEC SP_EXECUTESQL @CREATE_LOGIN;
PRINT N'NEW LOGIN ' + @NEW_USER + ' CREATED';

-- DROP USER
DECLARE @DROP_USER NVARCHAR(MAX)
SET @DROP_USER = 'USE ' + QUOTENAME(@DB) + '; DROP USER ' + QUOTENAME(@NEW_USER);
EXEC SP_EXECUTESQL @DROP_USER
PRINT N'USER ' + @NEW_USER + ' DROPPED'

-- CREATE NEW USER
DECLARE @CREATE_USER NVARCHAR(MAX);
SET @CREATE_USER = 'USE ' + QUOTENAME(@DB) + '; CREATE USER ' + QUOTENAME(@NEW_USER) + ' FROM EXTERNAL PROVIDER;';
EXEC SP_EXECUTESQL @CREATE_USER;
PRINT N'NEW USER ' + @NEW_USER + ' CREATED';

-- GRANT DB_DATAREADER ROLE ON DATABASE
DECLARE @GRANT_PERMISSIONS NVARCHAR(MAX);
SET @GRANT_PERMISSIONS = 'USE ' + QUOTENAME(@DB) + '; ALTER ROLE db_datareader ADD MEMBER ' + QUOTENAME(@NEW_USER);
EXEC SP_EXECUTESQL @GRANT_PERMISSIONS;
PRINT N'NEW USER ' + @NEW_USER + ' GRANTED DB_DATAREADER ROLE ON DATABASE ' + @DB;


/*
CHECK USER EXISTS - OBJECT ID SHOULD MATCH APP ID FROM ENTRA ID FOR MANAGED IDENTITIES
IF YOU RECREATE A USER WITH THE SAME NAME THE OBJECT ID WILL REMAIN THE SAME BUT MAY NOT
MATCH THE NEW MANAGED IDENTITY APP ID, HENCE THE NEED TO DROP THE USER FIRST BEFORE CREATING
AGAIN
*/

--SID to OBJECTID CHECK. AMEND DTAABASE ACCORDINGLY.
USE ODW_CURATED_DB;
SELECT
	DP.name
	,DP.principal_id
	,DP.type
	,DP.type_desc
	,DP.SID
	,OBJECTID = CONVERT(uniqueidentifier, DP.SID)
FROM SYS.database_principals DP
WHERE DP.type IN ('S','X','E')


-- SAMPLE CODE TO LIST DATABASE ROLE MEMBERS. AMEND DATABASE ACCORDINGLY.

USE ODW_CURATED_DB;
SELECT DP1.name AS DatabaseRoleName,   
   isnull (DP2.name, 'No members') AS DatabaseUserName   
 FROM sys.database_role_members AS DRM  
 RIGHT OUTER JOIN sys.database_principals AS DP1  
   ON DRM.role_principal_id = DP1.principal_id  
 LEFT OUTER JOIN sys.database_principals AS DP2  
   ON DRM.member_principal_id = DP2.principal_id  
WHERE DP1.type = 'R'
ORDER BY DP1.name;

```