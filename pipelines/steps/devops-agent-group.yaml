parameters:
  name: armServiceConnectionName
  type: string
  name: resourceGroupName
  type: string
  name: location
  type: string
  default: 'UK South'

steps:
  - task: AzurePowerShell@5
    displayName: 'Create Agent Group'
    inputs:
      ConnectedServiceNameARM: ${{ parameters.armServiceConnectionName }}
      errorActionPreference: 'stop'
      inline: |
        Write-Host "Checking for resource group ${{ parameters.resourceGroupName }}..."
        Write-Host "##[command]Get-AzResourceGroup -Name ${{ parameters.resourceGroupName }}"
        $Check = Get-AzResourceGroup -Name ${{ parameters.resourceGroupName }} -ErrorAction 'SilentlyContinue'

        If ($null -eq $Check) {
          Try {
            Write-Host "Creating resource group ${{ parameters.resourceGroupName }}..."
            Write-Host "##[command]New-AzResourceGroup -Name ${{ parameters.resourceGroupName }} -Location ${{ parameters.location }}"
            $Group = New-AzResourceGroup -Name ${{ parameters.resourceGroupName }} -Location ${{ parameters.location }}
            $Group | ConvertTo-Json

          } Catch {
            Write-Host "##[error]$_.Exception.Message"
            Exit 1
          }

        } Else {
          Write-Host "Resource group ${{ parameters.resourceGroupName }} already exists"
          $Check | ConvertTo-Json
        }
      scriptType: inlineScript
      TargetAzurePs: LatestVersion
